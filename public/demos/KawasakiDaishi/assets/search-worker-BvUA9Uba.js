(function(){"use strict";class v{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(t,s){let i=this.length++;for(;i>0;){const h=i-1>>1,r=this.values[h];if(s>=r)break;this.ids[i]=this.ids[h],this.values[i]=r,i=h}this.ids[i]=t,this.values[i]=s}pop(){if(this.length===0)return;const t=this.ids[0];if(this.length--,this.length>0){const s=this.ids[0]=this.ids[this.length],i=this.values[0]=this.values[this.length],h=this.length>>1;let r=0;for(;r<h;){let n=(r<<1)+1;const e=n+1;let o=this.ids[n],c=this.values[n];const a=this.values[e];if(e<this.length&&a<c&&(n=e,o=this.ids[e],c=a),c>=i)break;this.ids[r]=o,this.values[r]=c,r=n}this.ids[r]=s,this.values[r]=i}return t}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}const b=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],m=3;class _{static from(t,s=0){if(s%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!t||t.byteLength===void 0||t.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[i,h]=new Uint8Array(t,s+0,2);if(i!==251)throw new Error("Data does not appear to be in a Flatbush format.");const r=h>>4;if(r!==m)throw new Error(`Got v${r} data when expected v${m}.`);const n=b[h&15];if(!n)throw new Error("Unrecognized array type.");const[e]=new Uint16Array(t,s+2,1),[o]=new Uint32Array(t,s+4,1);return new _(o,e,n,void 0,t,s)}constructor(t,s=16,i=Float64Array,h=ArrayBuffer,r,n=0){if(t===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(t)||t<=0)throw new Error(`Unexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+s,2),65535),this.byteOffset=n;let e=t,o=e;this._levelBounds=[e*4];do e=Math.ceil(e/this.nodeSize),o+=e,this._levelBounds.push(o*4);while(e!==1);this.ArrayType=i,this.IndexArrayType=o<16384?Uint16Array:Uint32Array;const c=b.indexOf(this.ArrayType),a=o*4*this.ArrayType.BYTES_PER_ELEMENT;if(c<0)throw new Error(`Unexpected typed array class: ${i}.`);r&&r.byteLength!==void 0&&!r.buffer?(this.data=r,this._boxes=new this.ArrayType(this.data,n+8,o*4),this._indices=new this.IndexArrayType(this.data,n+8+a,o),this._pos=o*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1]):(this.data=new h(8+a+o*this.IndexArrayType.BYTES_PER_ELEMENT),this._boxes=new this.ArrayType(this.data,8,o*4),this._indices=new this.IndexArrayType(this.data,8+a,o),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(this.data,0,2).set([251,(m<<4)+c]),new Uint16Array(this.data,2,1)[0]=s,new Uint32Array(this.data,4,1)[0]=t),this._queue=new v}add(t,s,i=t,h=s){const r=this._pos>>2,n=this._boxes;return this._indices[r]=r,n[this._pos++]=t,n[this._pos++]=s,n[this._pos++]=i,n[this._pos++]=h,t<this.minX&&(this.minX=t),s<this.minY&&(this.minY=s),i>this.maxX&&(this.maxX=i),h>this.maxY&&(this.maxY=h),r}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const t=this._boxes;if(this.numItems<=this.nodeSize){t[this._pos++]=this.minX,t[this._pos++]=this.minY,t[this._pos++]=this.maxX,t[this._pos++]=this.maxY;return}const s=this.maxX-this.minX||1,i=this.maxY-this.minY||1,h=new Uint32Array(this.numItems),r=65535;for(let n=0,e=0;n<this.numItems;n++){const o=t[e++],c=t[e++],a=t[e++],u=t[e++],f=Math.floor(r*((o+a)/2-this.minX)/s),d=Math.floor(r*((c+u)/2-this.minY)/i);h[n]=I(f,d)}y(h,t,this._indices,0,this.numItems-1,this.nodeSize);for(let n=0,e=0;n<this._levelBounds.length-1;n++){const o=this._levelBounds[n];for(;e<o;){const c=e;let a=t[e++],u=t[e++],f=t[e++],d=t[e++];for(let p=1;p<this.nodeSize&&e<o;p++)a=Math.min(a,t[e++]),u=Math.min(u,t[e++]),f=Math.max(f,t[e++]),d=Math.max(d,t[e++]);this._indices[this._pos>>2]=c,t[this._pos++]=a,t[this._pos++]=u,t[this._pos++]=f,t[this._pos++]=d}}}search(t,s,i,h,r){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let n=this._boxes.length-4;const e=[],o=[];for(;n!==void 0;){const c=Math.min(n+this.nodeSize*4,A(n,this._levelBounds));for(let a=n;a<c;a+=4){if(i<this._boxes[a]||h<this._boxes[a+1]||t>this._boxes[a+2]||s>this._boxes[a+3])continue;const u=this._indices[a>>2]|0;n>=this.numItems*4?e.push(u):(r===void 0||r(u))&&o.push(u)}n=e.pop()}return o}neighbors(t,s,i=1/0,h=1/0,r){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let n=this._boxes.length-4;const e=this._queue,o=[],c=h*h;t:for(;n!==void 0;){const a=Math.min(n+this.nodeSize*4,A(n,this._levelBounds));for(let u=n;u<a;u+=4){const f=this._indices[u>>2]|0,d=g(t,this._boxes[u],this._boxes[u+2]),p=g(s,this._boxes[u+1],this._boxes[u+3]),w=d*d+p*p;w>c||(n>=this.numItems*4?e.push(f<<1,w):(r===void 0||r(f))&&e.push((f<<1)+1,w))}for(;e.length&&e.peek()&1;)if(e.peekValue()>c||(o.push(e.pop()>>1),o.length===i))break t;n=e.length?e.pop()>>1:void 0}return e.clear(),o}}function g(l,t,s){return l<t?t-l:l<=s?0:l-s}function A(l,t){let s=0,i=t.length-1;for(;s<i;){const h=s+i>>1;t[h]>l?i=h:s=h+1}return t[s]}function y(l,t,s,i,h,r){if(Math.floor(i/r)>=Math.floor(h/r))return;const n=l[i+h>>1];let e=i-1,o=h+1;for(;;){do e++;while(l[e]<n);do o--;while(l[o]>n);if(e>=o)break;E(l,t,s,e,o)}y(l,t,s,i,o,r),y(l,t,s,o+1,h,r)}function E(l,t,s,i,h){const r=l[i];l[i]=l[h],l[h]=r;const n=4*i,e=4*h,o=t[n],c=t[n+1],a=t[n+2],u=t[n+3];t[n]=t[e],t[n+1]=t[e+1],t[n+2]=t[e+2],t[n+3]=t[e+3],t[e]=o,t[e+1]=c,t[e+2]=a,t[e+3]=u;const f=s[i];s[i]=s[h],s[h]=f}function I(l,t){let s=l^t,i=65535^s,h=65535^(l|t),r=l&(t^65535),n=s|i>>1,e=s>>1^s,o=h>>1^i&r>>1^h,c=s&h>>1^r>>1^r;s=n,i=e,h=o,r=c,n=s&s>>2^i&i>>2,e=s&i>>2^i&(s^i)>>2,o^=s&h>>2^i&r>>2,c^=i&h>>2^(s^i)&r>>2,s=n,i=e,h=o,r=c,n=s&s>>4^i&i>>4,e=s&i>>4^i&(s^i)>>4,o^=s&h>>4^i&r>>4,c^=i&h>>4^(s^i)&r>>4,s=n,i=e,h=o,r=c,o^=s&h>>8^i&r>>8,c^=i&h>>8^(s^i)&r>>8,s=o^o>>1,i=c^c>>1;let a=l^t,u=i|65535^(a|s);return a=(a|a<<8)&16711935,a=(a|a<<4)&252645135,a=(a|a<<2)&858993459,a=(a|a<<1)&1431655765,u=(u|u<<8)&16711935,u=(u|u<<4)&252645135,u=(u|u<<2)&858993459,u=(u|u<<1)&1431655765,(u<<1|a)>>>0}function M(l){const t=l.length,s=new _(t),i={};for(const{a:h,lonlat:{x:r,y:n}}of l){const e=s.add(r,n);i[`${e}`]=h}return s.finish(),{fb:s,idxs:i}}function U(l){const t=M(l),s=new Map(l.map(({a:i,lonlat:h})=>[i,h]));return{b:t,m:s}}function T({b:l,m:t},s){const{fb:i,idxs:h}=l,r=i.neighbors(s.x,s.y,1,100);if(r.length===0)return null;const n=r[0],e=h[`${n}`],o=t.get(e);return o===void 0?null:{address:e,lonlat:o}}let x=null;onmessage=function(l){if(l.data.type==="INIT")x=U(l.data.entries),this.postMessage({type:"INIT.DONE"});else if(l.data.type==="SEARCH"){if(x===null)return;const t=l.data.pgeo,s=T(x,t);if(s===null)return;this.postMessage({type:"SEARCH.DONE",res:s})}}})();
