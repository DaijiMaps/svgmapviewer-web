(function(){"use strict";class Lt{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(t,e){let s=this.length++;for(;s>0;){const i=s-1>>1,r=this.values[i];if(e>=r)break;this.ids[s]=this.ids[i],this.values[s]=r,s=i}this.ids[s]=t,this.values[s]=e}pop(){if(this.length===0)return;const t=this.ids,e=this.values,s=t[0],i=--this.length;if(i>0){const r=t[i],o=e[i];let c=0;const h=i>>1;for(;c<h;){const f=(c<<1)+1,d=f+1,a=f+(+(d<i)&+(e[d]<e[f]));if(e[a]>=o)break;t[c]=t[a],e[c]=e[a],c=a}t[c]=r,e[c]=o}return s}peek(){return this.length>0?this.ids[0]:void 0}peekValue(){return this.length>0?this.values[0]:void 0}shrink(){this.ids.length=this.values.length=this.length}}const ht=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],X=3;class J{static from(t,e=0){if(e%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!t||t.byteLength===void 0||t.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[s,i]=new Uint8Array(t,e+0,2);if(s!==251)throw new Error("Data does not appear to be in a Flatbush format.");const r=i>>4;if(r!==X)throw new Error(`Got v${r} data when expected v${X}.`);const o=ht[i&15];if(!o)throw new Error("Unrecognized array type.");const[c]=new Uint16Array(t,e+2,1),[h]=new Uint32Array(t,e+4,1);return new J(h,c,o,void 0,t,e)}constructor(t,e=16,s=Float64Array,i=ArrayBuffer,r,o=0){if(t===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(t)||t<=0)throw new Error(`Unexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.byteOffset=o;let c=t,h=c;this._levelBounds=[c*4];do c=Math.ceil(c/this.nodeSize),h+=c,this._levelBounds.push(h*4);while(c!==1);this.ArrayType=s,this.IndexArrayType=h<16384?Uint16Array:Uint32Array;const f=ht.indexOf(s),d=h*4*s.BYTES_PER_ELEMENT;if(f<0)throw new Error(`Unexpected typed array class: ${s}.`);if(r)this.data=r,this._boxes=new s(r,o+8,h*4),this._indices=new this.IndexArrayType(r,o+8+d,h),this._pos=h*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1];else{const a=this.data=new i(8+d+h*this.IndexArrayType.BYTES_PER_ELEMENT);this._boxes=new s(a,8,h*4),this._indices=new this.IndexArrayType(a,8+d,h),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(a,0,2).set([251,(X<<4)+f]),new Uint16Array(a,2,1)[0]=e,new Uint32Array(a,4,1)[0]=t}this._queue=new Lt}add(t,e,s=t,i=e){const r=this._pos>>2,o=this._boxes;return this._indices[r]=r,o[this._pos++]=t,o[this._pos++]=e,o[this._pos++]=s,o[this._pos++]=i,t<this.minX&&(this.minX=t),e<this.minY&&(this.minY=e),s>this.maxX&&(this.maxX=s),i>this.maxY&&(this.maxY=i),r}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const t=this._boxes;if(this.numItems<=this.nodeSize){t[this._pos++]=this.minX,t[this._pos++]=this.minY,t[this._pos++]=this.maxX,t[this._pos++]=this.maxY;return}const e=this.maxX-this.minX||1,s=this.maxY-this.minY||1,i=new Uint32Array(this.numItems),r=65535;for(let o=0,c=0;o<this.numItems;o++){const h=t[c++],f=t[c++],d=t[c++],a=t[c++],u=Math.floor(r*((h+d)/2-this.minX)/e),l=Math.floor(r*((f+a)/2-this.minY)/s);i[o]=Jt(u,l)}q(i,t,this._indices,0,this.numItems-1,this.nodeSize);for(let o=0,c=0;o<this._levelBounds.length-1;o++){const h=this._levelBounds[o];for(;c<h;){const f=c;let d=t[c++],a=t[c++],u=t[c++],l=t[c++];for(let p=1;p<this.nodeSize&&c<h;p++)d=Math.min(d,t[c++]),a=Math.min(a,t[c++]),u=Math.max(u,t[c++]),l=Math.max(l,t[c++]);this._indices[this._pos>>2]=f,t[this._pos++]=d,t[this._pos++]=a,t[this._pos++]=u,t[this._pos++]=l}}}search(t,e,s,i,r){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let o=this._boxes.length-4;const c=[],h=[];for(;o!==void 0;){const f=Math.min(o+this.nodeSize*4,ut(o,this._levelBounds));for(let d=o;d<f;d+=4){const a=this._boxes[d];if(s<a)continue;const u=this._boxes[d+1];if(i<u)continue;const l=this._boxes[d+2];if(t>l)continue;const p=this._boxes[d+3];if(e>p)continue;const y=this._indices[d>>2]|0;o>=this.numItems*4?c.push(y):(r===void 0||r(y,a,u,l,p))&&h.push(y)}o=c.pop()}return h}neighbors(t,e,s=1/0,i=1/0,r){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let o=this._boxes.length-4;const c=this._queue,h=[],f=i*i;t:for(;o!==void 0;){const d=Math.min(o+this.nodeSize*4,ut(o,this._levelBounds));for(let a=o;a<d;a+=4){const u=this._indices[a>>2]|0,l=this._boxes[a],p=this._boxes[a+1],y=this._boxes[a+2],m=this._boxes[a+3],v=t<l?l-t:t>y?t-y:0,x=e<p?p-e:e>m?e-m:0,R=v*v+x*x;R>f||(o>=this.numItems*4?c.push(u<<1,R):(r===void 0||r(u))&&c.push((u<<1)+1,R))}for(;c.length&&c.peek()&1;)if(c.peekValue()>f||(h.push(c.pop()>>1),h.length===s))break t;o=c.length?c.pop()>>1:void 0}return c.clear(),h}}function ut(n,t){let e=0,s=t.length-1;for(;e<s;){const i=e+s>>1;t[i]>n?s=i:e=i+1}return t[e]}function q(n,t,e,s,i,r){if(Math.floor(s/r)>=Math.floor(i/r))return;const o=n[s],c=n[s+i>>1],h=n[i];let f=h;const d=Math.max(o,c);h>d?f=d:d===o?f=Math.max(c,h):d===c&&(f=Math.max(o,h));let a=s-1,u=i+1;for(;;){do a++;while(n[a]<f);do u--;while(n[u]>f);if(a>=u)break;Xt(n,t,e,a,u)}q(n,t,e,s,u,r),q(n,t,e,u+1,i,r)}function Xt(n,t,e,s,i){const r=n[s];n[s]=n[i],n[i]=r;const o=4*s,c=4*i,h=t[o],f=t[o+1],d=t[o+2],a=t[o+3];t[o]=t[c],t[o+1]=t[c+1],t[o+2]=t[c+2],t[o+3]=t[c+3],t[c]=h,t[c+1]=f,t[c+2]=d,t[c+3]=a;const u=e[s];e[s]=e[i],e[i]=u}function Jt(n,t){let e=n^t,s=65535^e,i=65535^(n|t),r=n&(t^65535),o=e|s>>1,c=e>>1^e,h=i>>1^s&r>>1^i,f=e&i>>1^r>>1^r;e=o,s=c,i=h,r=f,o=e&e>>2^s&s>>2,c=e&s>>2^s&(e^s)>>2,h^=e&i>>2^s&r>>2,f^=s&i>>2^(e^s)&r>>2,e=o,s=c,i=h,r=f,o=e&e>>4^s&s>>4,c=e&s>>4^s&(e^s)>>4,h^=e&i>>4^s&r>>4,f^=s&i>>4^(e^s)&r>>4,e=o,s=c,i=h,r=f,h^=e&i>>8^s&r>>8,f^=s&i>>8^(e^s)&r>>8,e=h^h>>1,s=f^f>>1;let d=n^t,a=s|65535^(d|e);return d=(d|d<<8)&16711935,d=(d|d<<4)&252645135,d=(d|d<<2)&858993459,d=(d|d<<1)&1431655765,a=(a|a<<8)&16711935,a=(a|a<<4)&252645135,a=(a|a<<2)&858993459,a=(a|a<<1)&1431655765,(a<<1|d)>>>0}function qt(n){const t=n.length,e=new J(t),s={};for(const{a:i,lonlat:{x:r,y:o}}of n){const c=e.add(r,o);s[`${c}`]=i}return e.finish(),{fb:e,idxs:s}}function Wt(n){const t=qt(n),e=new Map(n.map(({a:s,lonlat:i})=>[s,i]));return{b:t,m:e}}function Gt({b:n,m:t},e){const{fb:s,idxs:i}=n,r=s.neighbors(e.x,e.y,1,100);if(r.length===0)return null;const o=r[0],c=i[`${o}`],h=t.get(c);return h===void 0?null:{address:c,lonlat:h}}function Ht(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function Pt(){const n=Ht();if(n.__xstate__)return n.__xstate__}const Kt=n=>{if(typeof window>"u")return;const t=Pt();t&&t.register(n)};class ft{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const e={value:t,next:null};if(this._current){this._last.next=e,this._last=e;return}this._current=e,this._last=e,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const dt=".",Zt="",lt="",Vt="#",Nt="*",pt="xstate.init",W="xstate.stop";function Qt(n,t){return{type:`xstate.after.${n}.${t}`}}function G(n,t){return{type:`xstate.done.state.${n}`,output:t}}function te(n,t){return{type:`xstate.done.actor.${n}`,output:t,actorId:n}}function ee(n,t){return{type:`xstate.error.actor.${n}`,error:t,actorId:n}}function yt(n){return{type:pt,input:n}}function _(n){setTimeout(()=>{throw n})}const ne=typeof Symbol=="function"&&Symbol.observable||"@@observable";function mt(n,t){const e=gt(n),s=gt(t);return typeof s=="string"?typeof e=="string"?s===e:!1:typeof e=="string"?e in s:Object.keys(e).every(i=>i in s?mt(e[i],s[i]):!1)}function H(n){if(xt(n))return n;const t=[];let e="";for(let s=0;s<n.length;s++){switch(n.charCodeAt(s)){case 92:e+=n[s+1],s++;continue;case 46:t.push(e),e="";continue}e+=n[s]}return t.push(e),t}function gt(n){if(Fe(n))return n.value;if(typeof n!="string")return n;const t=H(n);return se(t)}function se(n){if(n.length===1)return n[0];const t={};let e=t;for(let s=0;s<n.length-1;s++)if(s===n.length-2)e[n[s]]=n[s+1];else{const i=e;e={},i[n[s]]=e}return t}function _t(n,t){const e={},s=Object.keys(n);for(let i=0;i<s.length;i++){const r=s[i];e[r]=t(n[r],r,n,i)}return e}function vt(n){return xt(n)?n:[n]}function S(n){return n===void 0?[]:vt(n)}function P(n,t,e,s){return typeof n=="function"?n({context:t,event:e,self:s}):n}function xt(n){return Array.isArray(n)}function ie(n){return n.type.startsWith("xstate.error.actor")}function A(n){return vt(n).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function St(n){if(!(n===void 0||n===Zt))return S(n)}function K(n,t,e){const s=typeof n=="object",i=s?n:void 0;return{next:(s?n.next:n)?.bind(i),error:(s?n.error:t)?.bind(i),complete:(s?n.complete:e)?.bind(i)}}function wt(n,t){return`${t}.${n}`}function Z(n,t){const e=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!e)return n.implementations.actors[t];const[,s,i]=e,o=n.getStateNodeById(i).config.invoke;return(Array.isArray(o)?o[s]:o).src}function bt(n,t){return`${n.sessionId}.${t}`}let re=0;function oe(n,t){const e=new Map,s=new Map,i=new WeakMap,r=new Set,o={},{clock:c,logger:h}=t,f={schedule:(u,l,p,y,m=Math.random().toString(36).slice(2))=>{const v={source:u,target:l,event:p,delay:y,id:m,startedAt:Date.now()},x=bt(u,m);a._snapshot._scheduledEvents[x]=v;const R=c.setTimeout(()=>{delete o[x],delete a._snapshot._scheduledEvents[x],a._relay(u,l,p)},y);o[x]=R},cancel:(u,l)=>{const p=bt(u,l),y=o[p];delete o[p],delete a._snapshot._scheduledEvents[p],y!==void 0&&c.clearTimeout(y)},cancelAll:u=>{for(const l in a._snapshot._scheduledEvents){const p=a._snapshot._scheduledEvents[l];p.source===u&&f.cancel(u,p.id)}}},d=u=>{if(!r.size)return;const l={...u,rootId:n.sessionId};r.forEach(p=>p.next?.(l))},a={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${re++}`,_register:(u,l)=>(e.set(u,l),u),_unregister:u=>{e.delete(u.sessionId);const l=i.get(u);l!==void 0&&(s.delete(l),i.delete(u))},get:u=>s.get(u),_set:(u,l)=>{const p=s.get(u);if(p&&p!==l)throw new Error(`Actor with system ID '${u}' already exists.`);s.set(u,l),i.set(l,u)},inspect:u=>{const l=K(u);return r.add(l),{unsubscribe(){r.delete(l)}}},_sendInspectionEvent:d,_relay:(u,l,p)=>{a._sendInspectionEvent({type:"@xstate.event",sourceRef:u,actorRef:l,event:p}),l._send(p)},scheduler:f,getSnapshot:()=>({_scheduledEvents:{...a._snapshot._scheduledEvents}}),start:()=>{const u=a._snapshot._scheduledEvents;a._snapshot._scheduledEvents={};for(const l in u){const{source:p,target:y,event:m,delay:v,id:x}=u[l];f.schedule(p,y,m,v,x)}},_clock:c,_logger:h};return a}let V=!1;const N=1;let g=function(n){return n[n.NotStarted=0]="NotStarted",n[n.Running=1]="Running",n[n.Stopped=2]="Stopped",n}({});const ce={clock:{setTimeout:(n,t)=>setTimeout(n,t),clearTimeout:n=>clearTimeout(n)},logger:console.log.bind(console),devTools:!1};class ae{constructor(t,e){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new ft(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=g.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...ce,...e},{clock:i,logger:r,parent:o,syncSnapshot:c,id:h,systemId:f,inspect:d}=s;this.system=o?o.system:oe(this,{clock:i,logger:r}),d&&!o&&this.system.inspect(K(d)),this.sessionId=this.system._bookId(),this.id=h??this.sessionId,this.logger=e?.logger??this.system._logger,this.clock=e?.clock??this.system._clock,this._parent=o,this._syncSnapshot=c,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:a=>{this._deferred.push(a)},system:this.system,stopChild:a=>{if(a._parent!==this)throw new Error(`Cannot stop child actor ${a.id} of ${this.id} because it is not a child`);a._stop()},emit:a=>{const u=this.eventListeners.get(a.type),l=this.eventListeners.get("*");if(!u&&!l)return;const p=[...u?u.values():[],...l?l.values():[]];for(const y of p)try{y(a)}catch(m){_(m)}},actionExecutor:a=>{const u=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:a.type,params:a.params}}),!a.exec)return;const l=V;try{V=!0,a.exec(a.info,a.params)}finally{V=l}};this._processingStatus===g.Running?u():this._deferred.push(u)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),f&&(this._systemId=f,this.system._set(f,this)),this._initState(e?.snapshot??e?.state),f&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(e){this._snapshot={status:"error",output:void 0,error:e}}}update(t,e){this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(i){this._deferred.length=0,this._snapshot={...t,status:"error",error:i}}switch(this._snapshot.status){case"active":for(const i of this.observers)try{i.next?.(t)}catch(r){_(r)}break;case"done":for(const i of this.observers)try{i.next?.(t)}catch(r){_(r)}this._stopProcedure(),this._complete(),this._doneEvent=te(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:e,snapshot:t})}subscribe(t,e,s){const i=K(t,e,s);if(this._processingStatus!==g.Stopped)this.observers.add(i);else switch(this._snapshot.status){case"done":try{i.complete?.()}catch(r){_(r)}break;case"error":{const r=this._snapshot.error;if(!i.error)_(r);else try{i.error(r)}catch(o){_(o)}break}}return{unsubscribe:()=>{this.observers.delete(i)}}}on(t,e){let s=this.eventListeners.get(t);s||(s=new Set,this.eventListeners.set(t,s));const i=e.bind(void 0);return s.add(i),{unsubscribe:()=>{s.delete(i)}}}start(){if(this._processingStatus===g.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=g.Running;const t=yt(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let e,s;try{e=this.logic.transition(this._snapshot,t,this._actorScope)}catch(i){s={err:i}}if(s){const{err:i}=s;this._snapshot={...this._snapshot,status:"error",error:i},this._error(i);return}this.update(e,t),t.type===W&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===g.Stopped?this:(this.mailbox.clear(),this._processingStatus===g.NotStarted?(this._processingStatus=g.Stopped,this):(this.mailbox.enqueue({type:W}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(e){_(e)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||_(t);return}let e=!1;for(const s of this.observers){const i=s.error;e||=!i;try{i?.(t)}catch(r){_(r)}}this.observers.clear(),e&&_(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,ee(this.id,t))}_stopProcedure(){return this._processingStatus!==g.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new ft(this._process.bind(this)),this._processingStatus=g.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==g.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:Kt)(this)}toJSON(){return{xstate$$type:N,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[ne](){return this}getSnapshot(){return this._snapshot}}function C(n,...[t]){return new ae(n,t)}function he(n,t,e,s,{sendId:i}){const r=typeof i=="function"?i(e,s):i;return[t,{sendId:r},void 0]}function ue(n,t){n.defer(()=>{n.system.scheduler.cancel(n.self,t.sendId)})}function fe(n){function t(e,s){}return t.type="xstate.cancel",t.sendId=n,t.resolve=he,t.execute=ue,t}function de(n,t,e,s,{id:i,systemId:r,src:o,input:c,syncSnapshot:h}){const f=typeof o=="string"?Z(t.machine,o):o,d=typeof i=="function"?i(e):i;let a,u;return f&&(u=typeof c=="function"?c({context:t.context,event:e.event,self:n.self}):c,a=C(f,{id:d,src:o,parent:n.self,syncSnapshot:h,systemId:r,input:u})),[I(t,{children:{...t.children,[d]:a}}),{id:i,systemId:r,actorRef:a,src:o,input:u},void 0]}function le(n,{actorRef:t}){t&&n.defer(()=>{t._processingStatus!==g.Stopped&&t.start()})}function pe(...[n,{id:t,systemId:e,input:s,syncSnapshot:i=!1}={}]){function r(o,c){}return r.type="xstate.spawnChild",r.id=t,r.systemId=e,r.src=n,r.input=s,r.syncSnapshot=i,r.resolve=de,r.execute=le,r}function ye(n,t,e,s,{actorRef:i}){const r=typeof i=="function"?i(e,s):i,o=typeof r=="string"?t.children[r]:r;let c=t.children;return o&&(c={...c},delete c[o.id]),[I(t,{children:c}),o,void 0]}function me(n,t){if(t){if(n.system._unregister(t),t._processingStatus!==g.Running){n.stopChild(t);return}n.defer(()=>{n.stopChild(t)})}}function Et(n){function t(e,s){}return t.type="xstate.stopChild",t.actorRef=n,t.resolve=ye,t.execute=me,t}function Q(n,t,e,s){const{machine:i}=s,r=typeof n=="function",o=r?n:i.implementations.guards[typeof n=="string"?n:n.type];if(!r&&!o)throw new Error(`Guard '${typeof n=="string"?n:n.type}' is not implemented.'.`);if(typeof o!="function")return Q(o,t,e,s);const c={context:t,event:e},h=r||typeof n=="string"?void 0:"params"in n?typeof n.params=="function"?n.params({context:t,event:e}):n.params:void 0;return"check"in o?o.check(s,c,o):o(c,h)}const tt=n=>n.type==="atomic"||n.type==="final";function T(n){return Object.values(n.states).filter(t=>t.type!=="history")}function D(n,t){const e=[];if(t===n)return e;let s=n.parent;for(;s&&s!==t;)e.push(s),s=s.parent;return e}function F(n){const t=new Set(n),e=At(t);for(const s of t)if(s.type==="compound"&&(!e.get(s)||!e.get(s).length))$t(s).forEach(i=>t.add(i));else if(s.type==="parallel"){for(const i of T(s))if(i.type!=="history"&&!t.has(i)){const r=$t(i);for(const o of r)t.add(o)}}for(const s of t){let i=s.parent;for(;i;)t.add(i),i=i.parent}return t}function It(n,t){const e=t.get(n);if(!e)return{};if(n.type==="compound"){const i=e[0];if(i){if(tt(i))return i.key}else return{}}const s={};for(const i of e)s[i.key]=It(i,t);return s}function At(n){const t=new Map;for(const e of n)t.has(e)||t.set(e,[]),e.parent&&(t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e));return t}function Tt(n,t){const e=F(t);return It(n,At(e))}function et(n,t){return t.type==="compound"?T(t).some(e=>e.type==="final"&&n.has(e)):t.type==="parallel"?T(t).every(e=>et(n,e)):t.type==="final"}const B=n=>n[0]===Vt;function ge(n,t){return n.transitions.get(t)||[...n.transitions.keys()].filter(s=>{if(s===Nt)return!0;if(!s.endsWith(".*"))return!1;const i=s.split("."),r=t.split(".");for(let o=0;o<i.length;o++){const c=i[o],h=r[o];if(c==="*")return o===i.length-1;if(c!==h)return!1}return!0}).sort((s,i)=>i.length-s.length).flatMap(s=>n.transitions.get(s))}function _e(n){const t=n.config.after;if(!t)return[];const e=i=>{const r=Qt(i,n.id),o=r.type;return n.entry.push(Ge(r,{id:o,delay:i})),n.exit.push(fe(o)),o};return Object.keys(t).flatMap(i=>{const r=t[i],o=typeof r=="string"?{target:r}:r,c=Number.isNaN(+i)?i:+i,h=e(c);return S(o).map(f=>({...f,event:h,delay:c}))}).map(i=>{const{delay:r}=i;return{...b(n,i.event,i),delay:r}})}function b(n,t,e){const s=St(e.target),i=e.reenter??!1,r=Se(n,s),o={...e,actions:S(e.actions),guard:e.guard,target:r,source:n,reenter:i,eventType:t,toJSON:()=>({...o,source:`#${n.id}`,target:r?r.map(c=>`#${c.id}`):void 0})};return o}function ve(n){const t=new Map;if(n.config.on)for(const e of Object.keys(n.config.on)){if(e===lt)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=n.config.on[e];t.set(e,A(s).map(i=>b(n,e,i)))}if(n.config.onDone){const e=`xstate.done.state.${n.id}`;t.set(e,A(n.config.onDone).map(s=>b(n,e,s)))}for(const e of n.invoke){if(e.onDone){const s=`xstate.done.actor.${e.id}`;t.set(s,A(e.onDone).map(i=>b(n,s,i)))}if(e.onError){const s=`xstate.error.actor.${e.id}`;t.set(s,A(e.onError).map(i=>b(n,s,i)))}if(e.onSnapshot){const s=`xstate.snapshot.${e.id}`;t.set(s,A(e.onSnapshot).map(i=>b(n,s,i)))}}for(const e of n.after){let s=t.get(e.eventType);s||(s=[],t.set(e.eventType,s)),s.push(e)}return t}function xe(n,t){const e=typeof t=="string"?n.states[t]:t?n.states[t.target]:void 0;if(!e&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${n.id}`);const s={source:n,actions:!t||typeof t=="string"?[]:S(t.actions),eventType:null,reenter:!1,target:e?[e]:[],toJSON:()=>({...s,source:`#${n.id}`,target:e?[`#${e.id}`]:[]})};return s}function Se(n,t){if(t!==void 0)return t.map(e=>{if(typeof e!="string")return e;if(B(e))return n.machine.getStateNodeById(e);const s=e[0]===dt;if(s&&!n.parent)return U(n,e.slice(1));const i=s?n.key+e:e;if(n.parent)try{return U(n.parent,i)}catch(r){throw new Error(`Invalid transition definition for state node '${n.id}':
${r.message}`)}else throw new Error(`Invalid target: "${e}" is not a valid target from the root node. Did you mean ".${e}"?`)})}function kt(n){const t=St(n.config.target);return t?{target:t.map(e=>typeof e=="string"?U(n.parent,e):e)}:n.parent.initial}function E(n){return n.type==="history"}function $t(n){const t=Mt(n);for(const e of t)for(const s of D(e,n))t.add(s);return t}function Mt(n){const t=new Set;function e(s){if(!t.has(s)){if(t.add(s),s.type==="compound")e(s.initial.target[0]);else if(s.type==="parallel")for(const i of T(s))e(i)}}return e(n),t}function k(n,t){if(B(t))return n.machine.getStateNodeById(t);if(!n.states)throw new Error(`Unable to retrieve child state '${t}' from '${n.id}'; no child states exist.`);const e=n.states[t];if(!e)throw new Error(`Child state '${t}' does not exist on '${n.id}'`);return e}function U(n,t){if(typeof t=="string"&&B(t))try{return n.machine.getStateNodeById(t)}catch{}const e=H(t).slice();let s=n;for(;e.length;){const i=e.shift();if(!i.length)break;s=k(s,i)}return s}function Y(n,t){if(typeof t=="string"){const i=n.states[t];if(!i)throw new Error(`State '${t}' does not exist on '${n.id}'`);return[n,i]}const e=Object.keys(t),s=e.map(i=>k(n,i)).filter(Boolean);return[n.machine.root,n].concat(s,e.reduce((i,r)=>{const o=k(n,r);if(!o)return i;const c=Y(o,t[r]);return i.concat(c)},[]))}function we(n,t,e,s){const r=k(n,t).next(e,s);return!r||!r.length?n.next(e,s):r}function be(n,t,e,s){const i=Object.keys(t),r=k(n,i[0]),o=nt(r,t[i[0]],e,s);return!o||!o.length?n.next(e,s):o}function Ee(n,t,e,s){const i=[];for(const r of Object.keys(t)){const o=t[r];if(!o)continue;const c=k(n,r),h=nt(c,o,e,s);h&&i.push(...h)}return i.length?i:n.next(e,s)}function nt(n,t,e,s){return typeof t=="string"?we(n,t,e,s):Object.keys(t).length===1?be(n,t,e,s):Ee(n,t,e,s)}function Ie(n){return Object.keys(n.states).map(t=>n.states[t]).filter(t=>t.type==="history")}function w(n,t){let e=n;for(;e.parent&&e.parent!==t;)e=e.parent;return e.parent===t}function Ae(n,t){const e=new Set(n),s=new Set(t);for(const i of e)if(s.has(i))return!0;for(const i of s)if(e.has(i))return!0;return!1}function Ot(n,t,e){const s=new Set;for(const i of n){let r=!1;const o=new Set;for(const c of s)if(Ae(it([i],t,e),it([c],t,e)))if(w(i.source,c.source))o.add(c);else{r=!0;break}if(!r){for(const c of o)s.delete(c);s.add(i)}}return Array.from(s)}function Te(n){const[t,...e]=n;for(const s of D(t,void 0))if(e.every(i=>w(i,s)))return s}function st(n,t){if(!n.target)return[];const e=new Set;for(const s of n.target)if(E(s))if(t[s.id])for(const i of t[s.id])e.add(i);else for(const i of st(kt(s),t))e.add(i);else e.add(s);return[...e]}function Ct(n,t){const e=st(n,t);if(!e)return;if(!n.reenter&&e.every(i=>i===n.source||w(i,n.source)))return n.source;const s=Te(e.concat(n.source));if(s)return s;if(!n.reenter)return n.source.machine.root}function it(n,t,e){const s=new Set;for(const i of n)if(i.target?.length){const r=Ct(i,e);i.reenter&&i.source===r&&s.add(r);for(const o of t)w(o,r)&&s.add(o)}return[...s]}function ke(n,t){if(n.length!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;return!0}function rt(n,t,e,s,i,r){if(!n.length)return t;const o=new Set(t._nodes);let c=t.historyValue;const h=Ot(n,o,c);let f=t;i||([f,c]=Ce(f,s,e,h,o,c,r,e.actionExecutor)),f=M(f,s,e,h.flatMap(a=>a.actions),r,void 0),f=Me(f,s,e,h,o,r,c,i);const d=[...o];f.status==="done"&&(f=M(f,s,e,d.sort((a,u)=>u.order-a.order).flatMap(a=>a.exit),r,void 0));try{return c===t.historyValue&&ke(t._nodes,o)?f:I(f,{_nodes:d,historyValue:c})}catch(a){throw a}}function $e(n,t,e,s,i){if(s.output===void 0)return;const r=G(i.id,i.output!==void 0&&i.parent?P(i.output,n.context,t,e.self):void 0);return P(s.output,n.context,r,e.self)}function Me(n,t,e,s,i,r,o,c){let h=n;const f=new Set,d=new Set;Oe(s,o,d,f),c&&d.add(n.machine.root);const a=new Set;for(const u of[...f].sort((l,p)=>l.order-p.order)){i.add(u);const l=[];l.push(...u.entry);for(const p of u.invoke)l.push(pe(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(d.has(u)){const p=u.initial.actions;l.push(...p)}if(h=M(h,t,e,l,r,u.invoke.map(p=>p.id)),u.type==="final"){const p=u.parent;let y=p?.type==="parallel"?p:p?.parent,m=y||u;for(p?.type==="compound"&&r.push(G(p.id,u.output!==void 0?P(u.output,h.context,t,e.self):void 0));y?.type==="parallel"&&!a.has(y)&&et(i,y);)a.add(y),r.push(G(y.id)),m=y,y=y.parent;if(y)continue;h=I(h,{status:"done",output:$e(h,t,e,h.machine.root,m)})}}return h}function Oe(n,t,e,s){for(const i of n){const r=Ct(i,t);for(const c of i.target||[])!E(c)&&(i.source!==c||i.source!==r||i.reenter)&&(s.add(c),e.add(c)),$(c,t,e,s);const o=st(i,t);for(const c of o){const h=D(c,r);r?.type==="parallel"&&h.push(r),Dt(s,t,e,h,!i.source.parent&&i.reenter?void 0:r)}}}function $(n,t,e,s){if(E(n))if(t[n.id]){const i=t[n.id];for(const r of i)s.add(r),$(r,t,e,s);for(const r of i)ot(r,n.parent,s,t,e)}else{const i=kt(n);for(const r of i.target)s.add(r),i===n.parent?.initial&&e.add(n.parent),$(r,t,e,s);for(const r of i.target)ot(r,n.parent,s,t,e)}else if(n.type==="compound"){const[i]=n.initial.target;E(i)||(s.add(i),e.add(i)),$(i,t,e,s),ot(i,n,s,t,e)}else if(n.type==="parallel")for(const i of T(n).filter(r=>!E(r)))[...s].some(r=>w(r,i))||(E(i)||(s.add(i),e.add(i)),$(i,t,e,s))}function Dt(n,t,e,s,i){for(const r of s)if((!i||w(r,i))&&n.add(r),r.type==="parallel")for(const o of T(r).filter(c=>!E(c)))[...n].some(c=>w(c,o))||(n.add(o),$(o,t,e,n))}function ot(n,t,e,s,i){Dt(e,s,i,D(n,t))}function Ce(n,t,e,s,i,r,o,c){let h=n;const f=it(s,i,r);f.sort((a,u)=>u.order-a.order);let d;for(const a of f)for(const u of Ie(a)){let l;u.history==="deep"?l=p=>tt(p)&&w(p,a):l=p=>p.parent===a,d??={...r},d[u.id]=Array.from(i).filter(l)}for(const a of f)h=M(h,t,e,[...a.exit,...a.invoke.map(u=>Et(u.id))],o,void 0),i.delete(a);return[h,d||r]}function De(n,t){return n.implementations.actions[t]}function jt(n,t,e,s,i,r){const{machine:o}=n;let c=n;for(const h of s){const f=typeof h=="function",d=f?h:De(o,typeof h=="string"?h:h.type),a={context:c.context,event:t,self:e.self,system:e.system},u=f||typeof h=="string"?void 0:"params"in h?typeof h.params=="function"?h.params({context:c.context,event:t}):h.params:void 0;if(!d||!("resolve"in d)){e.actionExecutor({type:typeof h=="string"?h:typeof h=="object"?h.type:h.name||"(anonymous)",info:a,params:u,exec:d});continue}const l=d,[p,y,m]=l.resolve(e,c,a,u,d,i);c=p,"retryResolve"in l&&r?.push([l,y]),"execute"in l&&e.actionExecutor({type:l.type,info:a,params:y,exec:l.execute.bind(null,e,y)}),m&&(c=jt(c,t,e,m,i,r))}return c}function M(n,t,e,s,i,r){const o=r?[]:void 0,c=jt(n,t,e,s,{internalQueue:i,deferredActorIds:r},o);return o?.forEach(([h,f])=>{h.retryResolve(e,c,f)}),c}function ct(n,t,e,s){let i=n;const r=[];function o(f,d,a){e.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:e.self,event:d,snapshot:f,_transitions:a}),r.push(f)}if(t.type===W)return i=I(Rt(i,t,e),{status:"stopped"}),o(i,t,[]),{snapshot:i,microstates:r};let c=t;if(c.type!==pt){const f=c,d=ie(f),a=Ft(f,i);if(d&&!a.length)return i=I(n,{status:"error",error:f.error}),o(i,f,[]),{snapshot:i,microstates:r};i=rt(a,n,e,c,!1,s),o(i,f,a)}let h=!0;for(;i.status==="active";){let f=h?je(i,c):[];const d=f.length?i:void 0;if(!f.length){if(!s.length)break;c=s.shift(),f=Ft(c,i)}i=rt(f,i,e,c,!1,s),h=i!==d,o(i,c,f)}return i.status!=="active"&&Rt(i,c,e),{snapshot:i,microstates:r}}function Rt(n,t,e){return M(n,t,e,Object.values(n.children).map(s=>Et(s)),[],void 0)}function Ft(n,t){return t.machine.getTransitionData(t,n)}function je(n,t){const e=new Set,s=n._nodes.filter(tt);for(const i of s)t:for(const r of[i].concat(D(i,void 0)))if(r.always){for(const o of r.always)if(o.guard===void 0||Q(o.guard,n.context,t,n)){e.add(o);break t}}return Ot(Array.from(e),new Set(n._nodes),n.historyValue)}function Re(n,t){const e=F(Y(n,t));return Tt(n,[...e])}function Fe(n){return!!n&&typeof n=="object"&&"machine"in n&&"value"in n}const Be=function(t){return mt(t,this.value)},Ue=function(t){return this.tags.has(t)},Ye=function(t){const e=this.machine.getTransitionData(this,t);return!!e?.length&&e.some(s=>s.target!==void 0||s.actions.length)},ze=function(){const{_nodes:t,tags:e,machine:s,getMeta:i,toJSON:r,can:o,hasTag:c,matches:h,...f}=this;return{...f,tags:Array.from(e)}},Le=function(){return this._nodes.reduce((t,e)=>(e.meta!==void 0&&(t[e.id]=e.meta),t),{})};function z(n,t){return{status:n.status,output:n.output,error:n.error,machine:t,context:n.context,_nodes:n._nodes,value:Tt(t.root,n._nodes),tags:new Set(n._nodes.flatMap(e=>e.tags)),children:n.children,historyValue:n.historyValue||{},matches:Be,hasTag:Ue,can:Ye,getMeta:Le,toJSON:ze}}function I(n,t={}){return z({...n,...t},n.machine)}function Xe(n){if(typeof n!="object"||n===null)return{};const t={};for(const e in n){const s=n[e];Array.isArray(s)&&(t[e]=s.map(i=>({id:i.id})))}return t}function Je(n,t){const{_nodes:e,tags:s,machine:i,children:r,context:o,can:c,hasTag:h,matches:f,getMeta:d,toJSON:a,...u}=n,l={};for(const y in r){const m=r[y];l[y]={snapshot:m.getPersistedSnapshot(t),src:m.src,systemId:m._systemId,syncSnapshot:m._syncSnapshot}}return{...u,context:Bt(o),children:l,historyValue:Xe(u.historyValue)}}function Bt(n){let t;for(const e in n){const s=n[e];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??=Array.isArray(n)?n.slice():{...n},t[e]={xstate$$type:N,id:s.id};else{const i=Bt(s);i!==s&&(t??=Array.isArray(n)?n.slice():{...n},t[e]=i)}}return t??n}function qe(n,t,e,s,{event:i,id:r,delay:o},{internalQueue:c}){const h=t.machine.implementations.delays;if(typeof i=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${i}" }) instead`);const f=typeof i=="function"?i(e,s):i;let d;if(typeof o=="string"){const a=h&&h[o];d=typeof a=="function"?a(e,s):a}else d=typeof o=="function"?o(e,s):o;return typeof d!="number"&&c.push(f),[t,{event:f,id:r,delay:d},void 0]}function We(n,t){const{event:e,delay:s,id:i}=t;if(typeof s=="number"){n.defer(()=>{const r=n.self;n.system.scheduler.schedule(r,r,e,s,i)});return}}function Ge(n,t){function e(s,i){}return e.type="xstate.raise",e.event=n,e.id=t?.id,e.delay=t?.delay,e.resolve=qe,e.execute=We,e}function He(n,{machine:t,context:e},s,i){const r=(o,c)=>{if(typeof o=="string"){const h=Z(t,o);if(!h)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const f=C(h,{id:c?.id,parent:n.self,syncSnapshot:c?.syncSnapshot,input:typeof c?.input=="function"?c.input({context:e,event:s,self:n.self}):c?.input,src:o,systemId:c?.systemId});return i[f.id]=f,f}else return C(o,{id:c?.id,parent:n.self,syncSnapshot:c?.syncSnapshot,input:c?.input,src:o,systemId:c?.systemId})};return(o,c)=>{const h=r(o,c);return i[h.id]=h,n.defer(()=>{h._processingStatus!==g.Stopped&&h.start()}),h}}function Pe(n,t,e,s,{assignment:i}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const r={},o={context:t.context,event:e.event,spawn:He(n,t,e.event,r),self:n.self,system:n.system};let c={};if(typeof i=="function")c=i(o,s);else for(const f of Object.keys(i)){const d=i[f];c[f]=typeof d=="function"?d(o,s):d}const h=Object.assign({},t.context,c);return[I(t,{context:h,children:Object.keys(r).length?{...t.children,...r}:t.children}),void 0,void 0]}function Ut(n){function t(e,s){}return t.type="xstate.assign",t.assignment=n,t.resolve=Pe,t}const Yt=new WeakMap;function O(n,t,e){let s=Yt.get(n);return s?t in s||(s[t]=e()):(s={[t]:e()},Yt.set(n,s)),s[t]}const Ke={},j=n=>typeof n=="string"?{type:n}:typeof n=="function"?"resolve"in n?{type:n.type}:{type:n.name}:n;class L{constructor(t,e){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=e._parent,this.key=e._key,this.machine=e._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(dt),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?_t(this.config.states,(s,i)=>new L(s,{_parent:this,_key:i,_machine:this.machine})):Ke,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=S(this.config.entry).slice(),this.exit=S(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=S(t.tags).slice()}_initialize(){this.transitions=ve(this),this.config.always&&(this.always=A(this.config.always).map(t=>b(this,lt,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(j),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(j),eventType:null})}:void 0,history:this.history,states:_t(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(j)})),entry:this.entry.map(j),exit:this.exit.map(j),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return O(this,"invoke",()=>S(this.config.invoke).map((t,e)=>{const{src:s,systemId:i}=t,r=t.id??wt(this.id,e),o=typeof s=="string"?s:`xstate.invoke.${wt(this.id,e)}`;return{...t,src:o,id:r,systemId:i,toJSON(){const{onDone:c,onError:h,...f}=t;return{...f,type:"xstate.invoke",src:o,id:r}}}}))}get on(){return O(this,"on",()=>[...this.transitions].flatMap(([e,s])=>s.map(i=>[e,i])).reduce((e,[s,i])=>(e[s]=e[s]||[],e[s].push(i),e),{}))}get after(){return O(this,"delayedTransitions",()=>_e(this))}get initial(){return O(this,"initial",()=>xe(this,this.config.initial))}next(t,e){const s=e.type,i=[];let r;const o=O(this,`candidates-${s}`,()=>ge(this,s));for(const c of o){const{guard:h}=c,f=t.context;let d=!1;try{d=!h||Q(h,f,e,t)}catch(a){const u=typeof h=="string"?h:typeof h=="object"?h.type:void 0;throw new Error(`Unable to evaluate guard ${u?`'${u}' `:""}in transition for event '${s}' in state node '${this.id}':
${a.message}`)}if(d){i.push(...c.actions),r=c;break}}return r?[r]:void 0}get events(){return O(this,"events",()=>{const{states:t}=this,e=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const i=t[s];if(i.states)for(const r of i.events)e.add(`${r}`)}return Array.from(e)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(e=>this.transitions.get(e).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(t)}}const Ze="#";class at{constructor(t,e){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:e?.actors??{},actions:e?.actions??{},delays:e?.delays??{},guards:e?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new L(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:e,guards:s,actors:i,delays:r}=this.implementations;return new at(this.config,{actions:{...e,...t.actions},guards:{...s,...t.guards},actors:{...i,...t.actors},delays:{...r,...t.delays}})}resolveState(t){const e=Re(this.root,t.value),s=F(Y(this.root,e));return z({_nodes:[...s],context:t.context||{},children:{},status:et(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,e,s){return ct(t,e,s,[]).snapshot}microstep(t,e,s){return ct(t,e,s,[]).microstates}getTransitionData(t,e){return nt(this.root,t.value,t,e)||[]}getPreInitialState(t,e,s){const{context:i}=this.config,r=z({context:typeof i!="function"&&i?i:{},_nodes:[this.root],children:{},status:"active"},this);return typeof i=="function"?M(r,e,t,[Ut(({spawn:c,event:h,self:f})=>i({spawn:c,input:h.input,self:f}))],s,void 0):r}getInitialSnapshot(t,e){const s=yt(e),i=[],r=this.getPreInitialState(t,s,i),o=rt([{target:[...Mt(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],r,t,s,!0,i),{snapshot:c}=ct(o,s,t,i);return c}start(t){Object.values(t.children).forEach(e=>{e.getSnapshot().status==="active"&&e.start()})}getStateNodeById(t){const e=H(t),s=e.slice(1),i=B(e[0])?e[0].slice(Ze.length):e[0],r=this.idMap.get(i);if(!r)throw new Error(`Child state node '#${i}' does not exist on machine '${this.id}'`);return U(r,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,e){return Je(t,e)}restoreSnapshot(t,e){const s={},i=t.children;Object.keys(i).forEach(a=>{const u=i[a],l=u.snapshot,p=u.src,y=typeof p=="string"?Z(this,p):p;if(!y)return;const m=C(y,{id:a,parent:e.self,syncSnapshot:u.syncSnapshot,snapshot:l,src:p,systemId:u.systemId});s[a]=m});function r(a,u){if(u instanceof L)return u;try{return a.machine.getStateNodeById(u.id)}catch{}}function o(a,u){if(!u||typeof u!="object")return{};const l={};for(const p in u){const y=u[p];for(const m of y){const v=r(a,m);v&&(l[p]??=[],l[p].push(v))}}return l}const c=o(this.root,t.historyValue),h=z({...t,children:s,_nodes:Array.from(F(Y(this.root,t.value))),historyValue:c},this),f=new Set;function d(a,u){if(!f.has(a)){f.add(a);for(const l in a){const p=a[l];if(p&&typeof p=="object"){if("xstate$$type"in p&&p.xstate$$type===N){a[l]=u[p.id];continue}d(p,u)}}}}return d(h.context,s),h}}function Ve(n,t){return new at(n,t)}function Ne({schemas:n,actors:t,actions:e,guards:s,delays:i}){return{createMachine:r=>Ve({...r,schemas:n},{actors:t,actions:e,guards:s,delays:i})}}const Qe=Ne({actions:{initDone:()=>postMessage({type:"INIT.DONE"}),doSearch:({context:{ctx:n}},{pgeo:t})=>{if(n===null)return;const e=Gt(n,t);e!==null&&postMessage({type:"SEARCH.DONE",res:e})}}}).createMachine({context:{ctx:null},initial:"Uninited",states:{Uninited:{on:{INIT:{actions:[Ut({ctx:({event:n})=>Wt(n.entries)}),{type:"initDone"}],target:"Inited"}}},Inited:{on:{SEARCH:[{actions:{type:"doSearch",params:({event:{pgeo:n}})=>({pgeo:n})}}]}}}}),zt=C(Qe);zt.start();function tn(n){zt.send(n)}onmessage=function(n){tn(n.data)}})();
