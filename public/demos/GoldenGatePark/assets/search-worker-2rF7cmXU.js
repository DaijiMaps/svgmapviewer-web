(function(){"use strict";class b{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(t,e){let s=this.length++;for(;s>0;){const n=s-1>>1,o=this.values[n];if(e>=o)break;this.ids[s]=this.ids[n],this.values[s]=o,s=n}this.ids[s]=t,this.values[s]=e}pop(){if(this.length===0)return;const t=this.ids[0];if(this.length--,this.length>0){const e=this.ids[0]=this.ids[this.length],s=this.values[0]=this.values[this.length],n=this.length>>1;let o=0;for(;o<n;){let r=(o<<1)+1;const i=r+1;let a=this.ids[r],d=this.values[r];const l=this.values[i];if(i<this.length&&l<d&&(r=i,a=this.ids[i],d=l),d>=s)break;this.ids[o]=a,this.values[o]=d,o=r}this.ids[o]=e,this.values[o]=s}return t}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}const g=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],m=3;class y{static from(t,e=0){if(e%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!t||t.byteLength===void 0||t.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[s,n]=new Uint8Array(t,e+0,2);if(s!==251)throw new Error("Data does not appear to be in a Flatbush format.");const o=n>>4;if(o!==m)throw new Error(`Got v${o} data when expected v${m}.`);const r=g[n&15];if(!r)throw new Error("Unrecognized array type.");const[i]=new Uint16Array(t,e+2,1),[a]=new Uint32Array(t,e+4,1);return new y(a,i,r,void 0,t,e)}constructor(t,e=16,s=Float64Array,n=ArrayBuffer,o,r=0){if(t===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(t)||t<=0)throw new Error(`Unexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.byteOffset=r;let i=t,a=i;this._levelBounds=[i*4];do i=Math.ceil(i/this.nodeSize),a+=i,this._levelBounds.push(a*4);while(i!==1);this.ArrayType=s,this.IndexArrayType=a<16384?Uint16Array:Uint32Array;const d=g.indexOf(this.ArrayType),l=a*4*this.ArrayType.BYTES_PER_ELEMENT;if(d<0)throw new Error(`Unexpected typed array class: ${s}.`);o&&o.byteLength!==void 0&&!o.buffer?(this.data=o,this._boxes=new this.ArrayType(this.data,r+8,a*4),this._indices=new this.IndexArrayType(this.data,r+8+l,a),this._pos=a*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1]):(this.data=new n(8+l+a*this.IndexArrayType.BYTES_PER_ELEMENT),this._boxes=new this.ArrayType(this.data,8,a*4),this._indices=new this.IndexArrayType(this.data,8+l,a),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(this.data,0,2).set([251,(m<<4)+d]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t),this._queue=new b}add(t,e,s=t,n=e){const o=this._pos>>2,r=this._boxes;return this._indices[o]=o,r[this._pos++]=t,r[this._pos++]=e,r[this._pos++]=s,r[this._pos++]=n,t<this.minX&&(this.minX=t),e<this.minY&&(this.minY=e),s>this.maxX&&(this.maxX=s),n>this.maxY&&(this.maxY=n),o}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const t=this._boxes;if(this.numItems<=this.nodeSize){t[this._pos++]=this.minX,t[this._pos++]=this.minY,t[this._pos++]=this.maxX,t[this._pos++]=this.maxY;return}const e=this.maxX-this.minX||1,s=this.maxY-this.minY||1,n=new Uint32Array(this.numItems),o=65535;for(let r=0,i=0;r<this.numItems;r++){const a=t[i++],d=t[i++],l=t[i++],c=t[i++],u=Math.floor(o*((a+l)/2-this.minX)/e),p=Math.floor(o*((d+c)/2-this.minY)/s);n[r]=I(u,p)}x(n,t,this._indices,0,this.numItems-1,this.nodeSize);for(let r=0,i=0;r<this._levelBounds.length-1;r++){const a=this._levelBounds[r];for(;i<a;){const d=i;let l=t[i++],c=t[i++],u=t[i++],p=t[i++];for(let f=1;f<this.nodeSize&&i<a;f++)l=Math.min(l,t[i++]),c=Math.min(c,t[i++]),u=Math.max(u,t[i++]),p=Math.max(p,t[i++]);this._indices[this._pos>>2]=d,t[this._pos++]=l,t[this._pos++]=c,t[this._pos++]=u,t[this._pos++]=p}}}search(t,e,s,n,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let r=this._boxes.length-4;const i=[],a=[];for(;r!==void 0;){const d=Math.min(r+this.nodeSize*4,A(r,this._levelBounds));for(let l=r;l<d;l+=4){if(s<this._boxes[l]||n<this._boxes[l+1]||t>this._boxes[l+2]||e>this._boxes[l+3])continue;const c=this._indices[l>>2]|0;r>=this.numItems*4?i.push(c):(o===void 0||o(c))&&a.push(c)}r=i.pop()}return a}neighbors(t,e,s=1/0,n=1/0,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let r=this._boxes.length-4;const i=this._queue,a=[],d=n*n;t:for(;r!==void 0;){const l=Math.min(r+this.nodeSize*4,A(r,this._levelBounds));for(let c=r;c<l;c+=4){const u=this._indices[c>>2]|0,p=w(t,this._boxes[c],this._boxes[c+2]),f=w(e,this._boxes[c+1],this._boxes[c+3]),_=p*p+f*f;_>d||(r>=this.numItems*4?i.push(u<<1,_):(o===void 0||o(u))&&i.push((u<<1)+1,_))}for(;i.length&&i.peek()&1;)if(i.peekValue()>d||(a.push(i.pop()>>1),a.length===s))break t;r=i.length?i.pop()>>1:void 0}return i.clear(),a}}function w(h,t,e){return h<t?t-h:h<=e?0:h-e}function A(h,t){let e=0,s=t.length-1;for(;e<s;){const n=e+s>>1;t[n]>h?s=n:e=n+1}return t[e]}function x(h,t,e,s,n,o){if(Math.floor(s/o)>=Math.floor(n/o))return;const r=h[s+n>>1];let i=s-1,a=n+1;for(;;){do i++;while(h[i]<r);do a--;while(h[a]>r);if(i>=a)break;$(h,t,e,i,a)}x(h,t,e,s,a,o),x(h,t,e,a+1,n,o)}function $(h,t,e,s,n){const o=h[s];h[s]=h[n],h[n]=o;const r=4*s,i=4*n,a=t[r],d=t[r+1],l=t[r+2],c=t[r+3];t[r]=t[i],t[r+1]=t[i+1],t[r+2]=t[i+2],t[r+3]=t[i+3],t[i]=a,t[i+1]=d,t[i+2]=l,t[i+3]=c;const u=e[s];e[s]=e[n],e[n]=u}function I(h,t){let e=h^t,s=65535^e,n=65535^(h|t),o=h&(t^65535),r=e|s>>1,i=e>>1^e,a=n>>1^s&o>>1^n,d=e&n>>1^o>>1^o;e=r,s=i,n=a,o=d,r=e&e>>2^s&s>>2,i=e&s>>2^s&(e^s)>>2,a^=e&n>>2^s&o>>2,d^=s&n>>2^(e^s)&o>>2,e=r,s=i,n=a,o=d,r=e&e>>4^s&s>>4,i=e&s>>4^s&(e^s)>>4,a^=e&n>>4^s&o>>4,d^=s&n>>4^(e^s)&o>>4,e=r,s=i,n=a,o=d,a^=e&n>>8^s&o>>8,d^=s&n>>8^(e^s)&o>>8,e=a^a>>1,s=d^d>>1;let l=h^t,c=s|65535^(l|e);return l=(l|l<<8)&16711935,l=(l|l<<4)&252645135,l=(l|l<<2)&858993459,l=(l|l<<1)&1431655765,c=(c|c<<8)&16711935,c=(c|c<<4)&252645135,c=(c|c<<2)&858993459,c=(c|c<<1)&1431655765,(c<<1|l)>>>0}function M(h){const t=h.length,e=new y(t),s={};for(const{a:n,lonlat:{x:o,y:r}}of h){const i=e.add(o,r);s[`${i}`]=n}return e.finish(),{fb:e,idxs:s}}function E(h){const t=M(h),e=new Map(h.map(({a:s,lonlat:n})=>[s,n]));return{b:t,m:e}}function v({b:h,m:t},e){const{fb:s,idxs:n}=h,o=s.neighbors(e.x,e.y,1,100);if(o.length===0)return null;const r=o[0],i=n[`${r}`],a=t.get(i);return a===void 0?null:{address:i,lonlat:a}}var T={type:"FeatureCollection",name:"map-centroids",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]},U={type:"FeatureCollection",name:"map-points",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]};const Y=()=>U.features.flatMap(h=>{var t,e;if((t=h.properties.name)!=null&&t.match(/./)){const s=h.geometry.coordinates[0],n=h.geometry.coordinates[1];return[{a:`lon=${s},lat=${n}`,lonlat:{x:s,y:n}}]}else if((e=h.properties.other_tags)!=null&&e.match(/"toilets"/)){const s=h.geometry.coordinates[0],n=h.geometry.coordinates[1];return[{a:`lon=${s},lat=${n}`,lonlat:{x:s,y:n}}]}else return[]}),B=()=>T.features.flatMap(h=>{var t,e;if((t=h.properties.name)!=null&&t.match(/./)){const s=h.geometry.coordinates[0],n=h.geometry.coordinates[1];return[{a:`lon=${s},lat=${n}`,lonlat:{x:s,y:n}}]}else if((e=h.properties.other_tags)!=null&&e.match(/"toilets"/)){const s=h.geometry.coordinates[0],n=h.geometry.coordinates[1];return[{a:`lon=${s},lat=${n}`,lonlat:{x:s,y:n}}]}else return[]}),F=[...Y(),...B()];function S(h,t){return{title:`Found: POI: (${t.x},${t.y})`,x:{tag:"shop",name:`${h} @ ${t.x}, ${t.y}`,address:h}}}const X=E(F);onmessage=function(h){const t=h.data.p,e=h.data.pgeo,s=v(X,e),n=s===null?null:S(s.address,s.lonlat),o=s===null||n===null?null:{p:t,pgeo:s.lonlat,info:n};F===null&&this.postMessage(null),this.postMessage(o)}})();
