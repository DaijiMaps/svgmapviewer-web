(function(){"use strict";class b{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(t,s){let i=this.length++;for(;i>0;){const h=i-1>>1,o=this.values[h];if(s>=o)break;this.ids[i]=this.ids[h],this.values[i]=o,i=h}this.ids[i]=t,this.values[i]=s}pop(){if(this.length===0)return;const t=this.ids[0];if(this.length--,this.length>0){const s=this.ids[0]=this.ids[this.length],i=this.values[0]=this.values[this.length],h=this.length>>1;let o=0;for(;o<h;){let n=(o<<1)+1;const e=n+1;let r=this.ids[n],u=this.values[n];const a=this.values[e];if(e<this.length&&a<u&&(n=e,r=this.ids[e],u=a),u>=i)break;this.ids[o]=r,this.values[o]=u,o=n}this.ids[o]=s,this.values[o]=i}return t}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}const g=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],_=3;class x{static from(t,s=0){if(s%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!t||t.byteLength===void 0||t.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[i,h]=new Uint8Array(t,s+0,2);if(i!==251)throw new Error("Data does not appear to be in a Flatbush format.");const o=h>>4;if(o!==_)throw new Error(`Got v${o} data when expected v${_}.`);const n=g[h&15];if(!n)throw new Error("Unrecognized array type.");const[e]=new Uint16Array(t,s+2,1),[r]=new Uint32Array(t,s+4,1);return new x(r,e,n,void 0,t,s)}constructor(t,s=16,i=Float64Array,h=ArrayBuffer,o,n=0){if(t===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(t)||t<=0)throw new Error(`Unexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+s,2),65535),this.byteOffset=n;let e=t,r=e;this._levelBounds=[e*4];do e=Math.ceil(e/this.nodeSize),r+=e,this._levelBounds.push(r*4);while(e!==1);this.ArrayType=i,this.IndexArrayType=r<16384?Uint16Array:Uint32Array;const u=g.indexOf(this.ArrayType),a=r*4*this.ArrayType.BYTES_PER_ELEMENT;if(u<0)throw new Error(`Unexpected typed array class: ${i}.`);o&&o.byteLength!==void 0&&!o.buffer?(this.data=o,this._boxes=new this.ArrayType(this.data,n+8,r*4),this._indices=new this.IndexArrayType(this.data,n+8+a,r),this._pos=r*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1]):(this.data=new h(8+a+r*this.IndexArrayType.BYTES_PER_ELEMENT),this._boxes=new this.ArrayType(this.data,8,r*4),this._indices=new this.IndexArrayType(this.data,8+a,r),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(this.data,0,2).set([251,(_<<4)+u]),new Uint16Array(this.data,2,1)[0]=s,new Uint32Array(this.data,4,1)[0]=t),this._queue=new b}add(t,s,i=t,h=s){const o=this._pos>>2,n=this._boxes;return this._indices[o]=o,n[this._pos++]=t,n[this._pos++]=s,n[this._pos++]=i,n[this._pos++]=h,t<this.minX&&(this.minX=t),s<this.minY&&(this.minY=s),i>this.maxX&&(this.maxX=i),h>this.maxY&&(this.maxY=h),o}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const t=this._boxes;if(this.numItems<=this.nodeSize){t[this._pos++]=this.minX,t[this._pos++]=this.minY,t[this._pos++]=this.maxX,t[this._pos++]=this.maxY;return}const s=this.maxX-this.minX||1,i=this.maxY-this.minY||1,h=new Uint32Array(this.numItems),o=65535;for(let n=0,e=0;n<this.numItems;n++){const r=t[e++],u=t[e++],a=t[e++],d=t[e++],c=Math.floor(o*((r+a)/2-this.minX)/s),f=Math.floor(o*((u+d)/2-this.minY)/i);h[n]=E(c,f)}y(h,t,this._indices,0,this.numItems-1,this.nodeSize);for(let n=0,e=0;n<this._levelBounds.length-1;n++){const r=this._levelBounds[n];for(;e<r;){const u=e;let a=t[e++],d=t[e++],c=t[e++],f=t[e++];for(let p=1;p<this.nodeSize&&e<r;p++)a=Math.min(a,t[e++]),d=Math.min(d,t[e++]),c=Math.max(c,t[e++]),f=Math.max(f,t[e++]);this._indices[this._pos>>2]=u,t[this._pos++]=a,t[this._pos++]=d,t[this._pos++]=c,t[this._pos++]=f}}}search(t,s,i,h,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let n=this._boxes.length-4;const e=[],r=[];for(;n!==void 0;){const u=Math.min(n+this.nodeSize*4,F(n,this._levelBounds));for(let a=n;a<u;a+=4){if(i<this._boxes[a]||h<this._boxes[a+1]||t>this._boxes[a+2]||s>this._boxes[a+3])continue;const d=this._indices[a>>2]|0;n>=this.numItems*4?e.push(d):(o===void 0||o(d))&&r.push(d)}n=e.pop()}return r}neighbors(t,s,i=1/0,h=1/0,o){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let n=this._boxes.length-4;const e=this._queue,r=[],u=h*h;t:for(;n!==void 0;){const a=Math.min(n+this.nodeSize*4,F(n,this._levelBounds));for(let d=n;d<a;d+=4){const c=this._indices[d>>2]|0,f=A(t,this._boxes[d],this._boxes[d+2]),p=A(s,this._boxes[d+1],this._boxes[d+3]),w=f*f+p*p;w>u||(n>=this.numItems*4?e.push(c<<1,w):(o===void 0||o(c))&&e.push((c<<1)+1,w))}for(;e.length&&e.peek()&1;)if(e.peekValue()>u||(r.push(e.pop()>>1),r.length===i))break t;n=e.length?e.pop()>>1:void 0}return e.clear(),r}}function A(l,t,s){return l<t?t-l:l<=s?0:l-s}function F(l,t){let s=0,i=t.length-1;for(;s<i;){const h=s+i>>1;t[h]>l?i=h:s=h+1}return t[s]}function y(l,t,s,i,h,o){if(Math.floor(i/o)>=Math.floor(h/o))return;const n=l[i+h>>1];let e=i-1,r=h+1;for(;;){do e++;while(l[e]<n);do r--;while(l[r]>n);if(e>=r)break;I(l,t,s,e,r)}y(l,t,s,i,r,o),y(l,t,s,r+1,h,o)}function I(l,t,s,i,h){const o=l[i];l[i]=l[h],l[h]=o;const n=4*i,e=4*h,r=t[n],u=t[n+1],a=t[n+2],d=t[n+3];t[n]=t[e],t[n+1]=t[e+1],t[n+2]=t[e+2],t[n+3]=t[e+3],t[e]=r,t[e+1]=u,t[e+2]=a,t[e+3]=d;const c=s[i];s[i]=s[h],s[h]=c}function E(l,t){let s=l^t,i=65535^s,h=65535^(l|t),o=l&(t^65535),n=s|i>>1,e=s>>1^s,r=h>>1^i&o>>1^h,u=s&h>>1^o>>1^o;s=n,i=e,h=r,o=u,n=s&s>>2^i&i>>2,e=s&i>>2^i&(s^i)>>2,r^=s&h>>2^i&o>>2,u^=i&h>>2^(s^i)&o>>2,s=n,i=e,h=r,o=u,n=s&s>>4^i&i>>4,e=s&i>>4^i&(s^i)>>4,r^=s&h>>4^i&o>>4,u^=i&h>>4^(s^i)&o>>4,s=n,i=e,h=r,o=u,r^=s&h>>8^i&o>>8,u^=i&h>>8^(s^i)&o>>8,s=r^r>>1,i=u^u>>1;let a=l^t,d=i|65535^(a|s);return a=(a|a<<8)&16711935,a=(a|a<<4)&252645135,a=(a|a<<2)&858993459,a=(a|a<<1)&1431655765,d=(d|d<<8)&16711935,d=(d|d<<4)&252645135,d=(d|d<<2)&858993459,d=(d|d<<1)&1431655765,(d<<1|a)>>>0}function M(l){const t=l.length,s=new x(t),i={};for(const{a:h,lonlat:{x:o,y:n}}of l){const e=s.add(o,n);i[`${e}`]=h}return s.finish(),{fb:s,idxs:i}}function T(l){const t=M(l),s=new Map(l.map(({a:i,lonlat:h})=>[i,h]));return{b:t,m:s}}function v({b:l,m:t},s){const{fb:i,idxs:h}=l,o=i.neighbors(s.x,s.y,1,100);if(o.length===0)return null;const n=o[0],e=h[`${n}`],r=t.get(e);return r===void 0?null:{address:e,lonlat:r}}let m=null;onmessage=function(l){if(l.data.type==="INIT")m=T(l.data.entries),this.postMessage({type:"INIT.DONE"});else if(l.data.type==="SEARCH"){if(m===null)return;const t=l.data.pgeo,s=v(m,t);if(s===null)return;this.postMessage({type:"SEARCH.DONE",res:s})}}})();
